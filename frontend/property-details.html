<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rental Property Details - Ileya</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#dc2626">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
        .thumbnail-active {
            border: 2px solid #DC2626; /* red-600 */
            opacity: 1;
            box-shadow: 0 0 5px rgba(220, 38, 38, 0.5);
        }
        .main-image-container {
            height: 500px;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans">
    <!-- Logo Header -->
    <header class="bg-white shadow-sm">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center">
                <img src="Img/logo.svg" alt="Ileya Logo" style="height:40px;" class="mr-2">
                <span class="sr-only">Ileya</span>
            </a>
        </nav>
    </header>
    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <div class="max-w-7xl mx-auto">
            <!-- Back Button -->
            <div class="mb-8">
                <button onclick="history.back()" class="inline-flex items-center text-sm font-medium text-gray-600 hover:text-gray-900">
                    <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                    Back to Listings
                </button>
            </div>

            <div id="property-details-container">
                <!-- Loading State -->
                <div id="loading-state" class="text-center py-20">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto"></div>
                    <p class="mt-4 text-lg text-gray-600">Loading property details...</p>
                </div>

                <!-- Error State -->
                <div id="error-state" class="hidden text-center py-20 bg-red-50 p-8 rounded-lg">
                    <p class="text-lg text-red-600">Could not load property details. Please try again later.</p>
                </div>

                <!-- Dynamic Content Area -->
                <div id="property-content" class="hidden">
                    <!-- Property details will be injected here -->
                </div>
            </div>
        </div>
    </main>

    <script src="js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const propertyContent = document.getElementById('property-content');

            const urlParams = new URLSearchParams(window.location.search);
            const propertyId = urlParams.get('id');

            if (!propertyId) {
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                errorState.querySelector('p').textContent = 'No property ID provided in the URL.';
                return;
            }

            try {
                const response = await fetch(`/api/rentals/${propertyId}`, { credentials: 'include' });
                if (!response.ok) {
                    throw new Error(`Failed to fetch property. Status: ${response.status}`);
                }
                const data = await response.json();
                
                if (data.success) {
                    const property = data.rental;
                    renderPropertyDetails(property);
                    document.title = `${property.title} - Ileya`;
                    loadingState.classList.add('hidden');
                    propertyContent.classList.remove('hidden');
                } else {
                    throw new Error(data.message || 'Could not retrieve property details.');
                }

            } catch (error) {
                console.error('Error fetching property details:', error);
                loadingState.classList.add('hidden');
                errorState.classList.remove('hidden');
                errorState.querySelector('p').textContent = `Error: ${error.message}`;
            }
        });

        function renderPropertyDetails(property) {
            const propertyContent = document.getElementById('property-content');
            const photos = property.photos && property.photos.length > 0 ? property.photos : ['/images/placeholder.png'];
            const cacheBuster = '?t=' + Date.now();
            const encode = (str) => encodeURIComponent(str).replace(/%2F/g, '/');
            let mainPhotoUrl;
            const firstPhoto = photos[0] || '';
            if (/^https?:\/\//.test(firstPhoto) || firstPhoto.startsWith('/uploads')) {
                mainPhotoUrl = encode(firstPhoto) + cacheBuster;
            } else if (firstPhoto.includes('uploads/')) {
                mainPhotoUrl = '/' + encode(firstPhoto) + cacheBuster;
            } else {
                mainPhotoUrl = `/uploads/rentals/${encode(firstPhoto)}${cacheBuster}`;
            }

            const thumbnailsHTML = photos.map((photo, index) => {
                let photoUrl;
                if (/^https?:\/\//.test(photo) || photo.startsWith('/uploads')) {
                    photoUrl = encode(photo) + cacheBuster;
                } else if (photo.includes('uploads/')) {
                    photoUrl = '/' + encode(photo) + cacheBuster;
                } else {
                    photoUrl = `/uploads/rentals/${encode(photo)}${cacheBuster}`;
                }
                return `
                    <div class="cursor-pointer" onclick="changeImage('${photoUrl}', this)">
                        <img src="${photoUrl}" alt="Thumbnail ${index + 1}" class="w-full h-24 object-cover rounded-lg ${index === 0 ? 'thumbnail-active' : ''}">
                    </div>
                `;
            }).join('');

            const featuresHTML = property.features && property.features.length > 0
                ? property.features.map(feature => `<li class="flex items-center"><i class="fas fa-check-circle text-red-500 mr-2"></i>${feature}</li>`).join('')
                : '<li>No features listed.</li>';
            
            const sanitizedDescription = (property.description || '').replace(/\n/g, '<br>');
            const whatsappLink = `https://wa.me/${formatWhatsappNumber(property.contact_phone)}?text=${encodeURIComponent(`Hello, I'm interested in your property listing \"${property.title}\" on Ileya.`)}`;

            propertyContent.innerHTML = `
                <!-- Title and Price Header -->
                <div class="mb-6">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900">${property.title}</h1>
                    <p class="text-lg text-gray-600 mt-1 capitalize">${property.city}, ${property.state}</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Image Gallery -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow-md overflow-hidden">
                            <div class="main-image-container bg-gray-200">
                                <img id="mainImage" src="${mainPhotoUrl}" alt="${property.title}" class="w-full h-full object-cover">
                            </div>
                            ${photos.length > 1 ? `
                            <div id="thumbnailContainer" class="p-4 grid grid-cols-3 sm:grid-cols-5 gap-3">
                                ${thumbnailsHTML}
                            </div>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Right Column: Details & Contact -->
                    <div class="lg:col-span-1">
                        <div class="sticky top-8">
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <p class="text-4xl font-bold text-red-600">â‚¦${new Intl.NumberFormat().format(property.rental_price)}<span class="text-lg font-medium text-gray-500">/year</span></p>
                                <div class="mt-6">
                                    <h3 class="text-xl font-semibold text-gray-800 mb-3">Contact Lister</h3>
                                    <div class="space-y-3">
                                        <a href="tel:${property.contact_phone}" class="w-full text-center bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition-colors flex items-center justify-center">
                                            <i class="fas fa-phone-alt mr-2"></i> Call Now
                                        </a>
                                        <a href="${whatsappLink}" target="_blank" class="w-full text-center bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center">
                                            <i class="fab fa-whatsapp mr-2"></i> Chat on WhatsApp
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bottom Section: Full Details -->
                <div class="mt-10 bg-white p-8 rounded-xl shadow-md">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Property Overview</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-6 mb-8 text-center">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <i class="fas fa-bed text-2xl text-red-500 mb-2"></i>
                            <p class="font-semibold text-gray-700">Bedrooms</p>
                            <p class="text-lg font-bold">${property.bedrooms || 'N/A'}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <i class="fas fa-home text-2xl text-red-500 mb-2"></i>
                            <p class="font-semibold text-gray-700">Property Type</p>
                            <p class="text-lg font-bold">${property.property_type || 'N/A'}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <i class="fas fa-tag text-2xl text-red-500 mb-2"></i>
                            <p class="font-semibold text-gray-700">Status</p>
                            <p class="text-lg font-bold capitalize">${property.status}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <i class="fas fa-calendar-alt text-2xl text-red-500 mb-2"></i>
                            <p class="font-semibold text-gray-700">Listed On</p>
                            <p class="text-lg font-bold">${new Date(property.created_at).toLocaleDateString()}</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 ${property.description && property.description.trim() !== '' ? 'md:grid-cols-2' : 'md:grid-cols-1'} gap-10">
                        ${property.description && property.description.trim() !== '' ? `
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Description</h3>
                            <div class="text-gray-700 leading-relaxed space-y-4">${sanitizedDescription}</div>
                        </div>
                        ` : ''}
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-4">Features</h3>
                            <ul id="featuresList" class="space-y-3 text-gray-700">
                                ${featuresHTML}
                            </ul>
                        </div>
                    </div>
                </div>
            `;
        }

        function changeImage(newSrc, thumbElement) {
            const mainImage = document.getElementById('mainImage');
            if(mainImage) mainImage.src = newSrc;

            document.querySelectorAll('#thumbnailContainer > div').forEach(thumbDiv => {
                thumbDiv.querySelector('img').classList.remove('thumbnail-active');
            });
            thumbElement.querySelector('img').classList.add('thumbnail-active');
        }

        function formatWhatsappNumber(phone) {
            let whatsappNumber = phone.replace(/\D/g, '');
            if (whatsappNumber.startsWith('0')) {
                whatsappNumber = '234' + whatsappNumber.substring(1);
            } else if (!whatsappNumber.startsWith('234')) {
                whatsappNumber = '234' + whatsappNumber;
            }
            return whatsappNumber;
        }
    </script>
    <!-- PWA Install Button -->
    <button id="install-button" class="hidden fixed bottom-4 right-4 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 z-50">
        <i class="fas fa-download mr-2"></i> Install App
    </button>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }

        // PWA Custom Install Prompt
        let deferredPrompt;
        const installButton = document.getElementById('install-button');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.classList.remove('hidden');
        });

        installButton.addEventListener('click', async () => {
            installButton.classList.add('hidden');
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to the install prompt: ${outcome}`);
            deferredPrompt = null;
        });

        window.addEventListener('appinstalled', () => {
            installButton.classList.add('hidden');
            deferredPrompt = null;
            console.log('Ileya PWA was installed');
        });
    </script>
</body>
</html>